; Yep I'm gonna be working on the kernel soon, right after i finish FAT stuff in boot secotr can you belive that ?
; 22 NOV 2023 

KERNEL_SIGN                 dw 0xBADF ;Kernel signature

[bits 16]
[SECTION .data]
        HEX_OUT             db "0x0000", 0, '$'
        KERNEL_START_MSG    db "Starting kernel!", 0, '$'

[SECTION .text]
    KERNEL_START:
        call INT22_INIT

        mov ah, 0x02
        mov si, KERNEL_START_MSG
        int 0x22

        hlt
        cli

    INT22_INIT:
        pusha

        cli
        xor ax, ax
        mov es, ax

        mov word ES:[136], INT_22
        mov word ES:[138], CS

        sti

        popa
        ret

    INT_22:
        cmp ah, 0x01
        je cls
        cmp ah, 0x02
        je printstr
        cmp ah, 0x03
        je printhex

    printstr:
        pusha

        .loop:
        mov ah, 0x0e
        mov al, [si]
        cmp al, 0x00
        jz .done
        int 0x10
        inc si
        jmp .loop

        .done:
        inc si
        cmp byte [si], '$'
        je .newline

        popa
        ret

        .newline:
        mov ah, 0x0E
        mov al, 0x0D
        int 0x10
        mov al, 0x0A
        int 0x10

        popa
        ret

    cls:
        pusha

        mov ah, 0x06
        xor al, al
        xor cx, cx
        xor bh, bh
        mov dh, 25
        mov dl, 80
        int 0x10
        mov ah, 0x03
        xor dx, dx
        int 0x10

        popa
        ret

    printhex:
        pusha
        mov ah, 0x0e
        mov cx, 4

        .loop:
        dec cx
        mov ax, dx
        shr dx, 4
        and ax, 0xF
        mov bx, HEX_OUT
        add bx, 2
        add bx, cx
        cmp ax, 0xA
        jl .set_letter
        add byte [bx], 7

        .set_letter:
        add byte [bx], al
        cmp cx, 0
        je .done
        jmp .loop

        .done:
        mov si, HEX_OUT
        call printstr
        mov bx, HEX_OUT
        add bx, 2

        .reset_leter:
        mov byte[bx], 0x30
        inc bx
        cmp byte[bx], 0
        jne .reset_leter
        popa
        ret